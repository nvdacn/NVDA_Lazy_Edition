name: build

on:
  push:
    tags:
      - "*"
    branches:
      - master
  pull_request:
    branches:
      - master
  workflow_dispatch:

env:
  NVDA: |
    name: nvda_2023.3.exe
    version: 2023.3
    URL: https://www.nvaccess.org/files/nvda/releases/2023.3/nvda_2023.3.exe
    sha256: f9898950beae6024939d00cc88121ac9e96a7d2cb76056539557c70bb0f6eacc

jobs:
  download-NVDA:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/cache@v4
        with:
          path: ./nvda*.exe
          key: nvda_${{ env.NVDA.version }}_${{ env.NVDA.sha256 }}
          restore-keys: |
            ${{ env.NVDA.name }}
          enableCrossOsArchive: true
      - name: Download NVDA
        id: download-nvda
        uses: carlosperate/download-file-action@v2
        with:
          file-url: ${{ env.NVDA.url }}
          sha256: ${{ env.NVDA.sha256 }}
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.NVDA.name }}
          path: ${{ steps.download-nvda.outputs.file-path }}
          if-no-files-found: error
  download-addons:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        addons:
          # - addonId: AiSound5
          # - addonId: DragAndDrop
          # - addonId: IBMTTS
          - addonId: MSEdgeDiscardAnnouncements
            displayName: Microsoft Edge discard announcements
            URL: >-
              https://github.com/beqabeqa473/MSEdgeDiscardAnnouncements/releases/download/v0.9/MSEdgeDiscardAnnouncements-0.9.nvda-addon
            description: >-
              Discards UIA announcements in Microsoft Edge such as page loading and
              refreshing, opening and closing tabs and windows.
            sha256: b2b4cee15b12caef8d7b0766d82a36992df9ccf422825d0db2b22855eff2a156
            addonVersionName: '0.9'
          - addonId: NVDACNMirror
            displayName: NVDA Chinese Community Update Mirror
            URL: https://dl.nvdacn.com/NVDA-Addons/New/NVDACNMirror-0.6.3.nvda-addon
            description: >-
              This update mirror source is provided for NVDA Chinese community users.

              It can enhance the update speed of NVDA, improve the search and download
              speed of the add-on store, and resolve issues where certain network
              operators are unable to download add-ons from the add-on store, thus
              effectively improving user experience.
            sha256: 06fe14c721dce045cf75a5a55442efad6ee21c119eb07ec276b132dd9f82a66d
            addonVersionName: 0.6.3
          - addonId: QQEnhancement
            displayName: PC QQ Enhancement
            URL: >-
              https://github.com/nvdacn/QQEnhancement/releases/download/v1.0.2/QQEnhancement-1.0.2.nvda-addon
            description: Enhance the experience of using PC QQ for NVDA users.
            sha256: a09a836356de60be6dd9dd34a9e31a77f4d89069aaacd78ac627c85855865459
            addonVersionName: 1.0.2
          # - addonId: QuickAdjustment
          - addonId: WakeSpeaker
            displayName: Wake Speaker
            URL: >-
              https://github.com/davidacm/WakeSpeaker/releases/download/0.4.0/WakeSpeaker-0.4.0.nvda-addon
            description: >-
              this add-on plays an inaudible white noise to keep alive the speakers.
              Useful for bluetooth headphones or similar devices.
            sha256: 65f7fb5d76f9941da914b9cf74bed430af885e0b4e48342dddb9dab5211773e5
            addonVersionName: 0.4.0
          - addonId: WeChatEnhancement
            displayName: PC WeChat Enhancement
            URL: >-
              https://github.com/cary-rowen/WeChatEnhancement/releases/download/v1.8.1/WeChatEnhancement-1.8.1.nvda-addon
            description: Enhance the experience of using PC WeChat for NVDA users.
            sha256: 0d0d4098903b60af6d0e73d7341a07f8741de4f6096a4cf7c38eddfc9fed7d1e
            addonVersionName: 1.8.1
          # - addonId: WorldVoice
          - addonId: addonUpdater
            displayName: Add-on Updater
            URL: >-
              https://github.com/josephsl/addonUpdater/releases/download/v24.2.1/addonUpdater-24.2.1.nvda-addon
            description: >-
              Proof of concept implementation of add-on update feature (NVDA Core issue
              3208)
            sha256: 3e9bbf22227fa4eebe2cf44fbaa48c87876be60058e15ce93023b9da7b658ba8
            addonVersionName: 24.2.1
          - addonId: addonsHelp
            displayName: Add-ons documentation
            URL: >-
              https://github.com/ruifontes/addonsHelp/releases/download/2024.03.20/addonsHelp-2024.03.20.nvda-addon
            description: >-
              This add-on provides a quick way to access documentation for the add-ons you
              have installed, creating, in the NVDA Help menu, two  sub-menus. One, called
              "Running add-ons documentation", grouping the documentation and a list of
              commands for running add-ons, and another sub-menu called "Disabled add-ons
              documentation",  listing the disabled add-ons documentation.
            sha256: 7c151abad0544157872f9247641db926ecfd7d0a2ac10703f898bc040b544ad6
            addonVersionName: 2024.03.20
          - addonId: audioManager
            displayName: Audio Manager
            URL: >-
              https://github.com/huaiyinfeilong/audiomanager/releases/download/v1.0.4/audioManager-1.0.4.nvda-addon
            description: An add-on of NVDA for system audio management.
            sha256: 733870053211b3adec12bd33fce14085aa1da6932f2aaf3458aec5ec2dffa450
            addonVersionName: 1.0.4
          - addonId: baiduTranslation
            displayName: Baidu Translation
            URL: >-
              https://github.com/huaiyinfeilong/baidutranslation/releases/download/v1.7.2/baiduTranslation-1.7.2.nvda-addon
            description: An NVDA add-on that provides baidu translation
            sha256: 053b50e68df6ee66a76621b37a9cfa6f95023c4e487023fdd60448341bd8eeb9
            addonVersionName: 1.7.2
          - addonId: clipboardEnhancement
            displayName: Clipboard Enhancement
            URL: >-
              https://github.com/cary-rowen/clipboardEnhancement/releases/download/v2.8.1/clipboardEnhancement-2.8.1.nvda-addon
            description: >-
              Clipboard Enhancement is an add-on for the NVDA (NonVisual Desktop Access)
              screen reader.

              This add-on is designed to enhance the functionality related to the
              clipboard and the text last spoken by NVDA.

              It aims to improve the user experience by providing more control and
              flexibility over the clipboard content and the text spoken by NVDA.
            sha256: 7525118c089a26ae725ab138a98b2ec70880d27cc1d3a9d69589a40dc8b33924
            addonVersionName: 2.8.1
          - addonId: enhancedTouchGestures
            displayName: Enhanced Touch Gestures
            URL: >-
              https://github.com/kefaslungu/enhancedTouchGestures/releases/download/23.06.1/enhancedTouchGestures-23.06.1.nvda-addon
            description: "A suite of additional touch commands, including navigation and help commands.\n\tRequires a touch-enabled computer with Windows 8.1 or later with NVDA 2017.4 or later installed."
            sha256: 1dbba2473874237fab0698e034fa34539b8eed7db0327bbebbb0751f226a2c4c
            addonVersionName: 23.06.1
          - addonId: goldenCursor
            displayName: Golden Cursor
            URL: >-
              https://github.com/nvda-es/goldenCursor/releases/download/6.3/goldenCursor-6.3.nvda-addon
            description: >-
              Allows you to control the mouse movement with the keyboard. for further
              details please visit the addon guide help.
            sha256: a46cb46740e12d319fba29aefc5ea8971d2d37dd872c04f6cb68535d9e0c3d82
            addonVersionName: '6.3'
          - addonId: ime_expressive
            displayName: Chinese input method support for NVDA
            URL: >-
              https://github.com/nvdacn/ime_expressive/releases/download/2024.3.21/ime_expressive-2024.3.21.nvda-addon
            description: >-
              This add-on provides Chinese input method support for the NVDA screen
              reader.

              It enhances the Chinese input experience in terms of input habits and
              efficiency for NVDA users.
            sha256: df2588afa530d937a6c4ba7824cd2eb06b051aac89081ad0afedd6137d219965
            addonVersionName: 2024.3.21
          # - addonId: numberProcessing
          - addonId: remote
            displayName: Remote Support
            URL: >-
              https://github.com/NVDARemote/NVDARemote/releases/download/v2.6.4/remote-2.6.4.nvda-addon
            description: Allows remote control of and remote access to another machine.
            sha256: 5dec96e279b3f4b36e1f61cfd4f63230c93db3d65335833afd4aef6fcdb390be
            addonVersionName: 2.6.4
          - addonId: resourceMonitor
            displayName: Resource Monitor
            URL: >-
              https://github.com/kefaslungu/resourceMonitor/releases/download/23.11/resourceMonitor-24.03.nvda-addon
            description: >-
              A handy resource monitor to report CPU load, memory usage, battery, disk
              usage status and more.
            sha256: 93ede13cd5655c3ab996de5fe1a92f746ecfe59259ce7bb704396a1e1def6eb1
            addonVersionName: '24.03'
          - addonId: unmute
            displayName: Unmute Windows audio
            URL: >-
              https://github.com/grisov/unmute/releases/download/v1.5.7/unmute-1.5.7.nvda-addon
            description: >-
              When NVDA starts, this add-on checks the status of the Windows sound system
              and, if the sound is turned off, turns it on.
            sha256: 0e5f2d997f449d65c1a13b855e34d2a82ee3be1040d37260f1decfeacf481791
            addonVersionName: 1.5.7
          - addonId: wintenApps
            displayName: Windows App Essentials
            URL: >-
              https://github.com/josephsl/wintenApps/releases/download/24.03/wintenApps-24.03.30.nvda-addon
            description: Improving support for various apps and controls on Windows 10 and later
            sha256: 26605b44865e13c62257d5c8fadb0af175236b03f8a32c87d3228744f113a91a
            addonVersionName: 24.03.30
          - addonId: xyOCR
            displayName: Xinyi OCR
            URL: >-
              https://github.com/huaiyinfeilong/xyOCR/releases/download/v3.0.1/xyOCR-3.0.1.nvda-addon
            description: Aggregating various offline and online OCR services
            sha256: 4ad0ff558e22a4917b2ac720dc2fcb7506dd3939d144a5285387f3bebcc1fe7d
            addonVersionName: 3.0.1
    steps:
      - uses: actions/cache@v4
        with:
          path: ./*.nvda-addon
          key: ${{ matrix.addons.addonId }}-${{ matrix.addons.addonVersionName }}-${{ matrix.addons.sha256 }}
          restore-keys: |
            ${{ matrix.addons.addonId }}-${{ matrix.addons.addonVersionName }}.nvda-addon
          enableCrossOsArchive: true
      - name: Download Addon
        id: download-addon
        uses: carlosperate/download-file-action@v2
        with:
          file-url: ${{ matrix.addons.URL }}
          sha256: ${{ matrix.addons.sha256 }}
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.addons.addonId }}-${{ matrix.addons.addonVersionName }}.nvda-addon
          path: ${{ steps.download-addon.outputs.file-path }}
          if-no-files-found: error
  build:
    runs-on: windows-latest
    needs:
      - download-NVDA
      - download-addons
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: nvda_2023.3.exe
      - uses: actions/download-artifact@v4
        with:
          path: Resource/Addons
          pattern: "*.nvda-addon"
          merge-multiple: true
      - run: tree
