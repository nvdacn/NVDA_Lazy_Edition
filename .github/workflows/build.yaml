name: Build NVDA Lazy Edition

on:
  push:
    tags:
      - "*"
    branches:
      - master
  pull_request:
    branches:
      - "*"
  workflow_dispatch:

jobs:

  download-files:
    name: Download ${{ matrix.file.Name }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        file:
          - Name: DragAndDrop-2.2.2dev.nvda-addon
            URL: https://github.com/javidominguez/DragAndDrop/releases/download/2.2.2dev/DragAndDrop-2.2.2dev.nvda-addon
            sha256: 7dc49d21be2c55ef340f3e67d650d2696df499765179e3f460ffac944632763e
          - Name: vcredist_x86.exe
            URL: https://dl.nvdacn.com/Share/vcredist_x86.exe
            sha256: B924AD8062EAF4E70437C8BE50FA612162795FF0839479546CE907FFA8D6E386
          - Name: aisound.zip
            URL: https://dl.nvdacn.com/NVDA-Addons/TTS/VocalizerVoice/aisound.zip
            sha256: B4FE1BED8F699179C8FF00F7B6F85AF4FF190ADCE1CCDB6C08132F93B7341EB2
            prefix: speech-
          - Name: VE.zip
            URL: https://dl.nvdacn.com/NVDA-Addons/TTS/VocalizerVoice/VE.zip
            sha256: 35ACAC34551ED8288DC6185A33127F5109AD6CB8901B329667C095DC0085EDD3
            prefix: speech-
          - Name: voice.zip
            URL: https://dl.nvdacn.com/Share/voice.zip
            sha256: AB2D6AFD7C5E12901DD3DA3CDC29325AA11A9DAB2EAC608D7B731993B2066450
            prefix: speech-
          - Name: spchapi.exe
            URL: https://dl.nvdacn.com/NVDA-Addons/TTS/spchapi.exe
            sha256: 4fe6f9be7a75d649e2d484069c3626d30345e746e565f0b7b1fcff34ef223a2c
            prefix: speech-
          - Name: IBM_ViaVoice_TTS_Runtime.exe
            URL: https://dl.nvdacn.com/NVDA-Addons/TTS/IBMViaVoiceTTSRuntime.exe
            sha256: 0f9e8a998f0bf62513961fe0cb68bc50e06440a6d8e45e8ce6e073e332104255
            prefix: speech-
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      - name: Download ${{ matrix.file.Name }}
        uses: ./.github/workflows/DownloadResource
        with:
          file-name: ${{ matrix.file.Name }}
          file-url: ${{ matrix.file.URL }}
          file-sha256: ${{ matrix.file.sha256 }}
          prefix: ${{ matrix.file.prefix }}

  download-addons-from-addonStore:
    name: Download ${{ matrix.addon.addonId }} from Addon Store
    runs-on: ubuntu-latest
    strategy:
      matrix:
        addon:
          - addonId: Access8Math
          - addonId: addonsHelp
          - addonId: addonsTools
          - addonId: AiSound5
          - addonId: audioManager
          - addonId: clipboardEnhancement
          - addonId: goldenCursor
          - addonId: ime_expressive
          - addonId: inputLock
          - addonId: instantTranslate
          - addonId: numberProcessing
          - addonId: objWatcher
          - addonId: QQEnhancement
          - addonId: resourceMonitor
          - addonId: unmute
          - addonId: WeChatEnhancement
          - addonId: withSounds
          - addonId: WorldVoice
          - addonId: xyOCR
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      - name: Download ${{ matrix.addon.addonId }}
        uses: ./.github/workflows/DownloadResource
        with:
          from-addonStore: true
          addon-ID: ${{ matrix.addon.addonId }}

  download-NVDA:
    name: Download NVDA
    runs-on: ubuntu-latest
    env:
      NVDA_RELEASES_BASE_URL: https://download.nvaccess.org/releases/
    outputs:
      NVDAFilename: nvda_${{ steps.nvda.outputs.replaced }}.exe
      NVDAVersion: ${{ steps.nvda.outputs.replaced }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      - name: Get tag
        id: nvda-tag
        uses: pozetroninc/github-action-get-latest-release@master
        with:
          repository: nvaccess/nvda
          excludes: ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') && !contains(github.ref, 'beta') && 'prerelease, draft' || '' }}
      - name: Processing tag
        id: nvda
        uses: frabert/replace-string-action@v2
        with:
          pattern: 'release-(.*)'
          string: ${{ steps.nvda-tag.outputs.release }}
          replace-with: '$1'
      - name: Download nvda_${{ steps.nvda.outputs.replaced }}.exe
        uses: ./.github/workflows/DownloadResource
        with:
          file-name: nvda_${{ steps.nvda.outputs.replaced }}.exe
          file-url: ${{ env.NVDA_RELEASES_BASE_URL }}/${{ steps.nvda.outputs.replaced }}/nvda_${{ steps.nvda.outputs.replaced }}.exe

  build:
    name: Build NVDA Lazy Edition
    runs-on: windows-latest
    needs:
      - download-NVDA
      - download-files
      - download-addons-from-addonStore
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      - name: Download ${{ needs.download-NVDA.outputs.NVDAFilename }}
        uses: actions/download-artifact@v6
        with:
          name: ${{ needs.download-NVDA.outputs.NVDAFilename }}
          path: ${{ github.workspace }}/Resource/
      - name: Download vcredist_x86.exe
        uses: actions/download-artifact@v6
        with:
          name: vcredist_x86.exe
          path: ${{ github.workspace }}/Resource/
      - name: Download Speech
        uses: actions/download-artifact@v6
        with:
          path: ${{ github.workspace }}/Resource/speech/
          pattern: speech-*
          merge-multiple: true
      - name: Download Addons
        uses: actions/download-artifact@v6
        with:
          path: ${{ github.workspace }}/Resource/Addons/
          pattern: "*.nvda-addon"
          merge-multiple: true
      - name: Run the build script
        run: ${{ github.workspace }}/Run.bat GITHUB_ACTIONS
        env:
          NVDAVersion: ${{ needs.download-NVDA.outputs.NVDAVersion }}
          BetaVersion: ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') && !contains(github.ref, 'beta') && 'False' || 'True' }}
      - name: Upload NVDA_Lazy_Edition
        if: ${{ !startsWith(github.ref, 'refs/tags/') }}
        uses: actions/upload-artifact@v5
        with:
          name: NVDA_Lazy_Edition
          path: ${{ github.workspace }}/Build/NVDA*.exe
      - name: Upload Resource
        if: ${{ !startsWith(github.ref, 'refs/tags/') }}
        uses: actions/upload-artifact@v5
        with:
          name: Resource
          path: ${{ github.workspace }}/Resource
          compression-level: 0
      - name: Upload Archive
        # if: ${{ startsWith(github.ref, 'refs/tags/') }}
        uses: actions/upload-artifact@v5
        with:
          name: Archive
          path: ${{ github.workspace }}/Build/Archive/*
          compression-level: 0

  github_release:
    name: Create Release on GitHUB
    runs-on: ubuntu-latest
    if: ${{ startsWith(github.ref, 'refs/tags/') }}
    needs: build
    permissions:
      contents: write
    steps:
      - name: Download Archive
        uses: actions/download-artifact@v6
        with:
          name: Archive
          path: NVDA_Lazy_Edition
      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          body: 详细更新日志请[点此查看](documentation/changes.md)。
          files: NVDA_Lazy_Edition/*
          fail_on_unmatched_files: true
          prerelease: ${{ contains(github.ref, 'beta') }}

  push_to_gitcode:
    name: Push to GitCode
    runs-on: ubuntu-latest
    # if: ${{ startsWith(github.ref, 'refs/tags/') }}
    env:
      GITCODE_TOKEN: ${{ secrets.GITCODE_TOKEN }}
      GITCODE_OWNER: ${{ vars.GITCODE_OWNER || github.repository_owner }}
      GITCODE_REPO: ${{ vars.GITCODE_REPO || github.event.repository.name }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Setup Git remote for GitCode
        run: |
          git config user.name "GitHub Actions"
          git config user.email "github-actions@github.com"
          git remote add gitcode https://${{ env.GITCODE_OWNER }}:${{ env.GITCODE_TOKEN }}@gitcode.com/${{ env.GITCODE_OWNER }}/${{ env.GITCODE_REPO }}.git
          git push gitcode --all --force
          git push gitcode --tags --force

  gitcode_release:
    name: Create Release on GitCode
    runs-on: ubuntu-latest
    needs:
      - push_to_gitcode
      - build
    env:
      GITCODE_TOKEN: ${{ secrets.GITCODE_TOKEN }}
      GITCODE_OWNER: ${{ vars.GITCODE_OWNER || github.repository_owner }}
      GITCODE_REPO: ${{ vars.GITCODE_REPO || github.event.repository.name }}
      TAG_NAME: "2025.10.27"
    steps:
      - name: Download Archive
        uses: actions/download-artifact@v6
        with:
          name: Archive
          path: NVDA_Lazy_Edition
      - name: Check if Release exists on GitCode
        id: check_release
        run: |
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: token ${{ env.GITCODE_TOKEN }}" \
            -H "Accept: application/json" \
            "https://gitcode.com/api/v5/repos/${{ env.GITCODE_OWNER }}/${{ env.GITCODE_REPO }}/releases/tags/${{ env.TAG_NAME }}")
          if [ "$RESPONSE" = "200" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Release already exists on GitCode"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Release does not exist on GitCode"
          fi
      - name: Create Release on GitCode
        if: steps.check_release.outputs.exists == 'false'
        id: create_release
        run: |
          echo "Creating new release on GitCode..."
          RESPONSE=$(curl -s -w "%{http_code}" -o response.json \
            -X POST \
            -H "Authorization: token ${{ env.GITCODE_TOKEN }}" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -d '{
              "tag_name": "'"${{ env.TAG_NAME }}"'",
              "target_commitish": "master",
              "name": "${{ env.TAG_NAME }}",
              "body": "详细更新日志请[点此查看](documentation/changes.md)。",
              "draft": false,
              "prerelease": '${{ contains(github.ref, 'beta') }}'
            }' \
            "https://gitcode.com/api/v5/repos/${{ env.GITCODE_OWNER }}/${{ env.GITCODE_REPO }}/releases")
          if [ "$RESPONSE" = "201" ]; then
            echo "✅ Release created successfully on GitCode"
            RELEASE_ID=$(cat response.json | jq -r '.id')
            echo "release_id=$RELEASE_ID" >> $GITHUB_OUTPUT
          else
            echo "❌ Failed to create release. Response code: $RESPONSE"
            cat response.json
            exit 1
          fi
      - name: Update Release on GitCode
        if: steps.check_release.outputs.exists == 'true'
        id: update_release
        run: |
          echo "Updating existing release on GitCode..."
          RELEASE_INFO=$(curl -s \
            -H "Authorization: token ${{ env.GITCODE_TOKEN }}" \
            -H "Accept: application/json" \
            "https://gitcode.com/api/v5/repos/${{ env.GITCODE_OWNER }}/${{ env.GITCODE_REPO }}/releases/tags/${{ env.TAG_NAME }}")
          RELEASE_ID=$(echo $RELEASE_INFO | jq -r '.id')
          RESPONSE=$(curl -s -w "%{http_code}" -o response.json \
            -X PATCH \
            -H "Authorization: token ${{ env.GITCODE_TOKEN }}" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -d '{
              "tag_name": "'"${{ env.TAG_NAME }}"'",
              "name": "${{ env.TAG_NAME }}",
              "body": "详细更新日志请[点此查看](documentation/changes.md)。",
              "prerelease": '${{ contains(github.ref, 'beta') }}'
            }' \
            "https://gitcode.com/api/v5/repos/${{ env.GITCODE_OWNER }}/${{ env.GITCODE_REPO }}/releases/$RELEASE_ID")
          
          if [ "$RESPONSE" = "200" ]; then
            echo "✅ Release updated successfully on GitCode"
            echo "release_id=$RELEASE_ID" >> $GITHUB_OUTPUT
          else
            echo "❌ Failed to update release. Response code: $RESPONSE"
            cat response.json
            exit 1
          fi
      - name: Get upload URL
        id: get_upload_url
        run: |
          RELEASE_ID=${{ fromJSON(steps.create_release.outputs.release_id || steps.update_release.outputs.release_id) }}
          UPLOAD_INFO=$(curl -s \
            -H "Authorization: token ${{ env.GITCODE_TOKEN }}" \
            -H "Accept: application/json" \
            "https://gitcode.com/api/v5/repos/${{ env.GITCODE_OWNER }}/${{ env.GITCODE_REPO }}/releases/$RELEASE_ID/upload_url")
          UPLOAD_URL=$(echo $UPLOAD_INFO | jq -r '.upload_url' | sed 's/{?name,label}//')
          if [ "$UPLOAD_URL" != "null" ] && [ -n "$UPLOAD_URL" ]; then
            echo "upload_url=$UPLOAD_URL" >> $GITHUB_OUTPUT
            echo "✅ Upload URL obtained: $UPLOAD_URL"
          else
            echo "❌ Could not get upload URL"
            echo $UPLOAD_INFO
            exit 1
          fi
      - name: Upload Build Artifacts to Release
        run: |
          UPLOAD_URL="${{ steps.get_upload_url.outputs.upload_url }}"
          echo "Uploading build artifacts to GitCode Release..."
          for file in NVDA_Lazy_Edition/*; do
            if [ -f "$file" ]; then
              FILENAME=$(basename "$file")
              echo "Uploading $FILENAME..."
              curl -X POST \
                -H "Authorization: token ${{ env.GITCODE_TOKEN }}" \
                -H "Content-Type: multipart/form-data" \
                -F "name=$FILENAME" \
                -F "label=$FILENAME - NVDA Lazy Edition 构建文件" \
                -F "file=@$file" \
                "$UPLOAD_URL"
              echo "✅ $FILENAME uploaded"
            fi
          done
          echo "✅ All artifacts uploaded successfully to GitCode Release"
